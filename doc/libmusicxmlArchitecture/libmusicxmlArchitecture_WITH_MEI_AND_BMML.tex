
% libmusicxml2 architecture overview
% Grame, 2021

%\documentclass[border=20pt]{standalone}
\documentclass[12pt,a4paper]{article}

% -------------------------------------------------------------------------
% import common LaTeX settings
% -------------------------------------------------------------------------

\usepackage{import}

\subimport{../}{CommonLaTeXSettings}

\usepackage{longtable}

\usepackage{tikz}

\usetikzlibrary{math}
%\usetikzlibrary{arrows.meta}

\usepackage{changepage} % for adjustwidth


% -------------------------------------------------------------------------
\begin{document}
% -------------------------------------------------------------------------

\def \tab {~~~}


\title{
\lib\ architecture overview \\[5pt]
{\normalsize 
  \xmlToGuido\ v2.3, \xmlToLy\ v0.9, \xmlToBrl\ v0.01\\
  \today
}
}

\author{
Jacques Menu 
}

%\date {(as of \normalsize \today)}
\date {}

\maketitle
\thispagestyle{fancy} % right after \maketitle to apply it to the first page too

{
	\small
	\tableofcontents
}

This document shows the architecture of the \lib\ library, to be found at 
\url {https://github.com/grame-cncm/libmusicxml/tree/lilypond}.

\lib\ is written in C++11 and provides a set of music scores representations and translators between various textual music scores formats. Building it only requires a C++11 compiler and {\tt cmake}.


% -------------------------------------------------------------------------
\section{Architecture}
% -------------------------------------------------------------------------

The picture at figure \ref {Architecture}, page \pageref {Architecture}, shows how \lib\ is structured. The dimmed, dashed arrows indicate items not yet available. 
The numbered arrows show the existing conversions between formats and representations.

\include {libmusicxmlArchitecturePicture_WITH_MEI_AND_BMML}

%\newpage


% -------------------------------------------------------------------------
\section{Formats and representations}
% -------------------------------------------------------------------------

The formats supported by \lib\ are:
%\begin{adjustwidth}{-0.5cm}{-0.5cm}
\begin{center}
\footnotesize
\def \contentsWidth{0.6\textwidth}
\def \arraystretch{1.3}
%
\begin{longtable}[t]{lp{\contentsWidth}}
{Format} & {Description} \tabularnewline[0.5ex]
\hline\\[-3.0ex]
%
\mxml\ & a text containg markups such as {\tt <part-list>}, {\tt <time>} and {\tt <note>};
\tabularnewline

\guido\ & a text containg markups such as {\tt $\backslash$barFormat}, {\tt $\backslash$tempo} and {\tt $\backslash$crescEnd};
\tabularnewline

\lily\ & a text containg commands such as {\tt $\backslash$header}, {\tt $\backslash$override} and {\tt $\backslash$transpose};
\tabularnewline

Jianpu \lily\ & a text containg \lily\ commands and the use of \lilyJianpu\ (\url {https://github.com/nybbs2003/lilypond-Jianpu/jianpu10a.ly}) to obtain a Jianpu (numbered) score instead of the default western notation. \lilyJianpu\ should be accessible to LilyPond for it to produce the score;
\tabularnewline

\braille\ & a text containg 6-dot cells, as described in \url {http://www.brailleauthority.org/music/Music_Braille_Code_2015.pdf};
\tabularnewline

\bmml\ & a text containg elements such as {\tt <score>}, 
  {\tt <score\_header>}, 
    {\tt <part\_list>}, 
      {\tt <part\_data>}, 
   {\tt <score\_data>} -- under development.
\tabularnewline

\mei\ & a text containg elements such as {\tt <meiHead>}, {\tt <scoreDef>} and {\tt <multiRest>} -- under development.
\tabularnewline

%\midi\ & binary data containg markups such as {\tt <part-list>}, {\tt <time>} and {\tt <note>};
%\tabularnewline

\end{longtable}
\end{center}

The representations used by \lib\ are:
%\begin{adjustwidth}{-0.5cm}{-0.5cm}
\begin{center}
\footnotesize
\def \contentsWidth{0.6\textwidth}
\def \arraystretch{1.3}
%
\begin{longtable}[t]{lp{\contentsWidth}}
{Representation} & {Description} \tabularnewline[0.5ex]
\hline\\[-3.0ex]
%
MSR & Music Score Representation, in terms of part groups, parts, staves, voices, notes, etc. This is the heart of the multi-language translators provided by \lib;
\tabularnewline

mxmlelement tree & a tree representing the \mxml\ markups such as {\tt <part-list>}, {\tt <time>} and {\tt <note>};
\tabularnewline

bmmlelement tree & a tree representing the \bmml\ markups such as {\tt <part-list>}, {\tt <time>} and {\tt <note>};
\tabularnewline

meielement tree & a tree representing the \mei\ markups such as {\tt <part-list>}, {\tt <time>} and {\tt <note>};
\tabularnewline

LPSR & LilyPond Score Representation, i.e. MSR plus LilyPond-specific items such as {\tt $\backslash$score} blocks;
\tabularnewline

BSR & Braille Score Representation, with pages, lines and 6-dots cells;
\tabularnewline

MDSR & MIDI Score Representation, to be designed.
\tabularnewline

%\texttt{RandomMusic} & generates an mxmlelement tree containing random music and writes it as \mxml
%\tabularnewline
%
%tools & a set of other demo programs such as {\tt countnotes}, {\tt xmltranspose} and {\tt partsummary}
%\tabularnewline
%
%\texttt{toBeWritten} & should generate an MSR containing some music and write it as \mxml, \lily and \braille
%\tabularnewline

\end{longtable}
\end{center}


\newpage

% -------------------------------------------------------------------------
\section{Basic tools}
% -------------------------------------------------------------------------

\lib\ supplies a number of basic tools using its features:

\begin{itemize}
\item {\tt xmlread} converts MusicXML data and displays the corresponding xmlElement tree;

\item {\tt countnotes} reads MusicXML data and displays the number of notes it contains;

\item other programs such as {\tt xmltranspose} and {\tt partsummary} demonstrate the possibilities of the library, in particular those of the two-phase visitors pattern it uses.

\item {\tt xml2midi} reads MusicXML data and outputs a midi version of it.
\end{itemize}

It is to be noted that:
\begin{itemize}
\item \lily\ provides \midiToLy\ to translate MIDI files to \lily\ code;
\item \lily\ can generate MIDI files from its input.
\end{itemize} 


% -------------------------------------------------------------------------
\section{Generators}
% -------------------------------------------------------------------------

A generator is an executable that creates data representing a score without reading any input file.
For example:
\begin{itemize}
\item \texttt{RandomMusic} generates an mxmlelement tree containing random music, and writes it as \mxml\ to standard output;

\item \texttt{RandomChords} generates an mxmlelement tree containing random two-note chords, and writes it as \mxml\ to standard output;

\item \texttt{MusicAndHarmonies.cpp} generates an mxmlelement tree containing notes and harmonies, and writes it as \mxml\ to standard output;
\end{itemize}


\newpage

% -------------------------------------------------------------------------
\section{Conversion passes}
% -------------------------------------------------------------------------

The numbers in the picture refer to so-called passes (compiler writing terminology), i.e. atomic components of the library that convert a representation into another. The passes are numbered in the order they were added to the library:
%\begin{adjustwidth}{-0.5cm}{-0.5cm}
\begin{center}
\footnotesize
\def \contentsWidth{0.7\textwidth}
\def \arraystretch{1.3}
%
\begin{longtable}[t]{cp{\contentsWidth}}
{Passes} & {Description} \tabularnewline[0.5ex]
\hline\\[-3.0ex]
%
\texttt{1} & reads \mxml\ data from a file or from standard input is '-' is supplied as the file name, and creates an mxmlelement tree containg the same data;
\tabularnewline

\texttt{2} & converts an mxmlelement tree into \mxml\ data. This is a mere 'print()' operation;
\tabularnewline

\texttt{3} & converts an mxmlelement tree into Guido text code, and writes it to standard output;
\tabularnewline

\texttt{4} & converts an mxmlelement tree into and MSR representation. \mxml\ represents how a score is to be drawn, while MSR represents the musical contents with great detail. This pass actually consists in two sub-passes: the first one builds an MSR skeleton containing empty voices and stanzas, and the second one the fills this with all the rest;
\tabularnewline

\texttt{5} & converts an MSR representation into another one, built from scratch. This allows the new representation to be different than the original one, for example to change the score after is has been scanned and exported as \mxml\ data, or to add skip (invisible) notes to avoid the \lily\ issue \#34. For simplicity and efficiency reasons, this pass is not present as such, but 'merges' within passes 6 and 9;
\tabularnewline

\texttt{6} & converts an MSR representation into an LPSR representation, which contains an MSR component build from the original MSR (pass 5). The BSR contains \lily-specific representations such as {\tt $\backslash$layout}, {\tt $\backslash$paper}, and {\tt $\backslash$score} blocks;
\tabularnewline

\texttt{7} & converts an LPSR representation into an MSR representation. There is nothing to do, since the former contains the latter as a component;
\tabularnewline

\texttt{8} & converts an LPSR representation into \lily\ text code, and writes it to standard output;
\tabularnewline

\texttt{8'} & converts an LPSR representation into \lily\ text code using \lilyJianpu, and writes it to standard output. This pass is run with {\tt xml2ly -jianpu};
\tabularnewline

\texttt{9} & converts an MSR representation into a BSR representation, which contains an MSR component build from the original MSR (pass 5). The BSR contains \braille-specific representations such as pages, lines and 6-dot cells. The lines and pages are virtual, i.e. not limited in length;
\tabularnewline

\texttt{10} & converts a BSR representation into an MSR representation. There is nothing to do, since the former contains the latter as a component;
\tabularnewline

\texttt{11} & converts a BSR representation into another one, to adapt the number of cells per line and lines per page from virtual to physical. Currently, the result is a mere clone;
\tabularnewline

\texttt{12} & converts a BSR representation into \braille\ text, and writes it to standard output;
\tabularnewline

\texttt{13} & reads \bmml\ data from a file or from standard input is '-' is supplied as the file name, and creates an bmmlelement tree containg the same data;
\tabularnewline

\texttt{\textcolor{gray}{14}} & converts an bmmlelement tree into \bmml\ data. This is a mere 'print()' operation;
\tabularnewline

\texttt{\textcolor{gray}{16}} & converts an bmmlelement tree into MSR data -- in design phase;
\tabularnewline

\texttt{\textcolor{gray}{17}} & converts MSR data into an bmmlelement tree -- in design phase.
\tabularnewline


\texttt{\textcolor{gray}{15}} & converts an MSR representation into an mxmlelement tree -- ongoing work;
\tabularnewline


\texttt{18} & reads \mei\ data from a file or from standard input is '-' is supplied as the file name, and creates an meielement tree containg the same data;
\tabularnewline

\texttt{\textcolor{gray}{19}} & converts an meielement tree into \mei\ data. This is a mere 'print()' operation;
\tabularnewline

\texttt{\textcolor{gray}{20}} & converts an meielement tree into MSR data -- in design phase;
\tabularnewline

\texttt{\textcolor{gray}{21}} & converts MSR data into an meielement tree -- in design phase.
\tabularnewline

\end{longtable}
\end{center}


% -------------------------------------------------------------------------
\section{Translators}
% -------------------------------------------------------------------------

A translator is a sequence of two or more passes, each converting one representation into another, in a pipeline way. The first one provided by the library was {\tt xml2guido}.

The other translators provided by \lib\ were added later and are in the form of functions. Executable command-line applications using them are also supplied. They are shown in the table below, in which the ones not yet planned or under development are dimmed:
%\begin{adjustwidth}{-0.5cm}{-0.5cm}
\begin{center}
\footnotesize
\def \contentsWidth{0.6\textwidth}
\def \arraystretch{1.3}
%
\begin{longtable}[t]{l|ccccccc}
 & \multicolumn{6}{c}{Output format} \tabularnewline
\raisebox{1em}{Input format} & \mxml & \guido & \lily & {Jianpu \lily} & \braille & \bmml & \mei \tabularnewline[0.5ex] 
\hline\\[-3.0ex]
%

\mxml\ & \xmlToXml & \xmlToGuido & \xmlToLy & \xmlToLy\ {\tt -jianpu} & \xmlToBrl & \textcolor{gray}{\xmlToBmml} & \textcolor{gray}{\xmlToMei}
\tabularnewline


\bmml\ & \textcolor{gray}{\bmmlToXml} & \textcolor{gray}{\bmmlToGuido} & \textcolor{gray}{\bmmlToLy} & \textcolor{gray}{\bmmlToLy\ {\tt -jianpu}} & \textcolor{gray}{\bmmlToBrl} & \textcolor{gray}{\bmmlToBmml} & \textcolor{gray}{\bmmlToMei}
\tabularnewline


\mei\ & \textcolor{gray}{\meiToXml} & \textcolor{gray}{\meiToGuido} & \textcolor{gray}{\meiToLy} & \textcolor{gray}{\meiToLy\ {\tt -jianpu}} & \textcolor{gray}{\meiToBrl} & \textcolor{gray}{\meiToBmml} & \textcolor{gray}{\meiToMei}
\tabularnewline


%\midi\ &  &  &  &  &  &  &
%\tabularnewline

\end{longtable}
\end{center}

The executables available, planned or under development in \lib\ are:
%\begin{adjustwidth}{-0.5cm}{-0.5cm}
\begin{center}
\footnotesize
\def \contentsWidth{0.7\textwidth}
\def \arraystretch{1.3}
%
\begin{longtable}[t]{lp{\contentsWidth}}
{Translator} & {Description} \tabularnewline[0.5ex]
\hline\\[-3.0ex]
%

\xmlToGuido & converts \mxml\ data to Guido code, using passes:

\tab\ 1 $\Rightarrow$ 3
\tabularnewline


\xmlToXml & converts \mxml\ data to MSR and back. This is useful to modify the data to suit the user's needs, such as fixing score scanning software limitations or to enhance the data:

\tab\ 1 $\Rightarrow$ 4 $\Rightarrow$ 5 $\Rightarrow$ 15 $\Rightarrow$ 2
\tabularnewline


\xmlToLy & performs the 4 hops from \mxml\ to \lily\ to translate the former into the latter, using these passes:

\tab\ 1 $\Rightarrow$ 4 $\Rightarrow$ 6 $\Rightarrow$ 8

The {\tt -jianpu} option is supplied to create Jianpu (numbered) scores, in which the notes are represented by numbers instead of graphics;

The {\tt -loop} option is supplied to create \mxml\ data back from the \mxml\ data, as is done by \xmlToXml;
\tabularnewline


\xmlToBrl & performs the 5 hops from \mxml\ to \braille\ to translate the former into the latter (draft);

\tab\ 1 $\Rightarrow$ 4 $\Rightarrow$ 5 $\Rightarrow$ 9 $\Rightarrow$ 11 $\Rightarrow$ 12
\tabularnewline



\textcolor{gray}{\bmmlToGuido} & converts \bmml\ data to Guido code, using passes:

\tab\ 13 $\Rightarrow$ 16 $\Rightarrow$ 15 $\Rightarrow$ 3
\tabularnewline


\textcolor{gray}{\bmmlToXml} & converts \bmml\ data to MusicXML code, using passes:

\tab\ 13 $\Rightarrow$ 16 $\Rightarrow$ 15 $\Rightarrow$ 2
\tabularnewline


\textcolor{gray}{\bmmlToBmml} & converts \bmml\ data to MSR and back:

\tab\ 13 $\Rightarrow$ 16 $\Rightarrow$ 16 $\Rightarrow$ 14
\tabularnewline


\textcolor{gray}{\bmmlToLy} & performs the 4 hops from \bmml\ to \lily\ to translate the former into the latter, using these passes:

\tab\ 13 $\Rightarrow$ 16 $\Rightarrow$ 6 $\Rightarrow$ 8


The {\tt -jianpu} option is supplied to create Jianpu (numbered) scores, in which the notes are represented by numbers instead of graphics;

The {\tt -loop} option is supplied to create \bmml\ data back from the \mei\ data, as is done by \bmmlToBmml;
\tabularnewline


\textcolor{gray}{\bmmlToBrl} & performs the 5 hops from \bmml\ to \braille\ to translate the former into the latter (draft):

\tab\ 13 $\Rightarrow$ 16 $\Rightarrow$ 9 $\Rightarrow$ 11  $\Rightarrow$ 12
\tabularnewline



\textcolor{gray}{\meiToGuido} & converts \mei\ data to Guido code, using passes:

\tab\ 18 $\Rightarrow$ 20 $\Rightarrow$ 15 $\Rightarrow$ 3
\tabularnewline


\textcolor{gray}{\meiToXml} & converts \mei\ data to Guido code, using passes:

\tab\ 18 $\Rightarrow$ 20 $\Rightarrow$ 15 $\Rightarrow$ 2
\tabularnewline


\textcolor{gray}{\meiToMei} & converts \mei\ data to MSR and back:

\tab\ 18 $\Rightarrow$ 20 $\Rightarrow$ 21 $\Rightarrow$ 19
\tabularnewline


\textcolor{gray}{\meiToLy} & performs the 4 hops from \mei\ to \lily\ to translate the former into the latter, using these passes:

\tab\ 18 $\Rightarrow$ 20 $\Rightarrow$ 6 $\Rightarrow$ 8


The {\tt -jianpu} option is supplied to create Jianpu (numbered) scores, in which the notes are represented by numbers instead of graphics;

The {\tt -loop} option is supplied to create \mei\ data back from the \mei\ data, as is done by \meiToMei;
\tabularnewline


\textcolor{gray}{\meiToBrl} & performs the 5 hops from \mei\ to \braille\ to translate the former into the latter (draft):

\tab\ 18 $\Rightarrow$ 20 $\Rightarrow$ 9 $\Rightarrow$ 11  $\Rightarrow$ 12
\tabularnewline


\textcolor{gray}{\xmlToBmml} & performs the 4 hops from \mxml\ to \bmml\ to translate the former into the latter:

\tab\ 1 $\Rightarrow$ 4 $\Rightarrow$ 17 $\Rightarrow$ 14
\tabularnewline


\textcolor{gray}{\xmlToMei} & performs the 4 hops from \mxml\ to \mei\ to translate the former into the latter:

\tab\ 1 $\Rightarrow$ 4 $\Rightarrow$ 21 $\Rightarrow$ 19
\tabularnewline


\end{longtable}
\end{center}


%\newpage



In order to demonstrate the use of the MSR API, {\tt Mikrokosmos3Wandering} creates an MSR graph representing Bartok's Mikrokosmos III Wandering score, and then produces Guido, LilyPond, braille or MusicXML to standard output, depending on the '{\tt -generated-code-kind}' option.

MSDL (Music Score Description Language) is a language under evolution being created by this author. It is meant for use by musicians, i.e. non-programmers, to obtain scores from a rather high-level description.\\
\lib supplies {\tt msdl}, a compiler translating MSDL into Guido, LilyPond, braille or MusicXML to standard output, depending on the '{\tt -generated-code-kind}' option.


% -------------------------------------------------------------------------
\section{Options and help}
% -------------------------------------------------------------------------

Having many executables with many options makes options and help handling a challenge.\\
This is why \lib\ uses it own OAH (Options And Help) object oriented infrastructure.

This library provides OAH (Options And Help), a full-fledged object-oriented options and help management infrastructure.

OAH organizes the options and the corresponding help in a hierarchy of groups, sub-groups and so-called atoms. OAH is introspective, thus help can be obtained for every group, sub-group or atom at will.

Each pass supplies a OAH group, containing its own options and help. The executable translators then aggregate the OAH groups of the passes they are composed of to offer their options and help to the user.


% -------------------------------------------------------------------------
\section{Multiple languages support}
% -------------------------------------------------------------------------


% -------------------------------------------------------------------------
\section{The MSR classes hierarchy}
% -------------------------------------------------------------------------


\include {msrClassesHierarchyPicture}



% -------------------------------------------------------------------------
\end{document}
% -------------------------------------------------------------------------
